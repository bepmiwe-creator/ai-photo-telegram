<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>AI Image Mini App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-slate-50 min-h-screen flex items-center justify-center">
  <div class="w-full max-w-md bg-slate-800 rounded-2xl p-6 shadow-xl">
    <h1 class="text-xl font-semibold mb-4 text-center">AI Image Generator</h1>

    <label class="block text-sm mb-1">Промпт</label>
    <textarea id="prompt" class="w-full rounded-md bg-slate-900 border border-slate-600 p-2 text-sm mb-3"
              rows="4" placeholder="Опишите желаемое изображение..."></textarea>

    <label class="block text-sm mb-1">Соотношение сторон</label>
    <select id="aspect" class="w-full rounded-md bg-slate-900 border border-slate-600 p-2 text-sm mb-4">
      <option value="1:1">1:1 (квадрат)</option>
      <option value="4:5">4:5 (портрет)</option>
      <option value="16:9">16:9 (широкий)</option>
      <option value="9:16">9:16 (сторис)</option>
    </select>

    <button id="generate-btn"
            class="w-full bg-emerald-500 hover:bg-emerald-400 text-slate-900 font-semibold py-2 rounded-lg transition">
      Сгенерировать
    </button>

    <div id="status" class="mt-3 text-xs text-slate-300"></div>

    <div id="result" class="mt-4 hidden">
      <p class="text-sm mb-2">Результат:</p>
      <img id="result-image" src="" alt="result" class="w-full rounded-lg border border-slate-700" />
    </div>
  </div>

  <script>
    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    if (tg) {
      tg.expand();
      tg.ready();
    }

    const generateBtn = document.getElementById('generate-btn');
    const promptEl = document.getElementById('prompt');
    const aspectEl = document.getElementById('aspect');
    const statusEl = document.getElementById('status');
    const resultEl = document.getElementById('result');
    const resultImg = document.getElementById('result-image');

    generateBtn.addEventListener('click', async () => {
      const prompt = (promptEl.value || '').trim();
      const aspect = aspectEl.value || '1:1';

      if (!prompt) {
        statusEl.textContent = 'Введите промпт.';
        return;
      }

      statusEl.textContent = 'Генерация...';
      generateBtn.disabled = true;

      const initData = tg && tg.initData ? tg.initData : '';

      try {
        const res = await fetch('/api/generate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Telegram-Init-Data': initData
          },
          body: JSON.stringify({ prompt, aspect_ratio: aspect })
        });

        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.detail || 'Ошибка генерации');
        }

        const data = await res.json();
        if (data.imageUrl) {
          resultImg.src = data.imageUrl;
          resultEl.classList.remove('hidden');
          statusEl.textContent = 'Готово!';
        } else {
          statusEl.textContent = 'Модель не вернула URL изображения.';
        }
      } catch (e) {
        statusEl.textContent = e.message || 'Ошибка запроса.';
      } finally {
        generateBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
